import J from"node:http";var x=class{routes;constructor(){this.routes=[]}addMiddleware(e,t,o){this.routes.push({method:e,path:t,middlewares:o,middleware:o[o.length-1]})}addRouterWithPrefix(e,t){t.routes&&Array.isArray(t.routes)?t.routes.forEach(o=>{this.routes.push({method:o.method,path:e+o.path,middlewares:o.middlewares,middleware:o.middleware})}):console.error("Router passado n\xE3o possui rotas definidas.")}find(e){let{method:t,url:o}=e;if(!o)return;let r=this.routes.find(n=>{let s=new RegExp("^"+n.path.replace(/\/:([^\/]+)/g,"/([^/]+)")+"$");return t===n.method&&s.test(o.split("?")[0])});if(r){let n=o.split("?")[0].match(new RegExp(r.path.replace(/\/:([^\/]+)/g,"/([^/]+)")));if(n){let s=(r.path.match(/\/:([^\/]+)/g)||[]).map(p=>p.replace("/:",""));e.params=e.params||{},s.forEach((p,d)=>{e.params[p]=n[d+1]})}}return r}get(e,...t){this.addMiddleware("GET",e,t)}post(e,...t){this.addMiddleware("POST",e,t)}put(e,...t){this.addMiddleware("PUT",e,t)}patch(e,...t){this.addMiddleware("PATCH",e,t)}delete(e,...t){this.addMiddleware("DELETE",e,t)}},R=x;var c=class{parse(e){let t=e.secure?"https":e.headers["x-forwarded-proto"]||"http",o=e.url?new URL(e.url,`${t}://${e.headers.host}`):new URL(`${t}://${e.headers.host}`);return Object.fromEntries(o.searchParams.entries())}};var f=class{async process(e,t,o){let r=o.find(e);if(!r){t.statusCode=404,t.end("Not Found");return}try{for(let n of r.middlewares)await new Promise((s,p)=>{n(e,t,d=>d?p(d):s())});r.middleware?r.middleware(e,t,()=>{}):(t.statusCode=500,t.end("Internal Server Error: No controller provided"))}catch(n){let s=n instanceof Error?n.message:"Unknown Error";t.statusCode=500,t.end(`Internal Server Error: ${s}`)}}};var I=class{constructor(e,t,o=new c,r=new f){this.middlewares=e;this.router=t;this.queryParams=o;this.processRouter=r}async handleRequest(e,t){e.params={},e.query=this.queryParams.parse(e);for(let o of this.middlewares)await new Promise((r,n)=>{o(e,t,s=>s?n(s):r())});await this.processRouter.process(e,t,this.router)}},j=I;var A=async(i,e,t)=>{if((i.method==="POST"||i.method==="PUT"||i.method==="PATCH")&&i.headers["content-type"]?.startsWith("application/json"))try{i.body=await new Promise((o,r)=>{let n="";i.on("data",s=>{n+=s.toString()}),i.on("end",()=>{try{o(JSON.parse(n))}catch(s){r(s)}}),i.on("error",s=>{r(s)})})}catch(o){o instanceof Error?(e.statusCode=400,e.end(`Erro no parse do JSON: ${o.message}`)):(e.statusCode=400,e.end("Erro desconhecido no parse do JSON"));return}t()},B=A;import y from"fs";import M from"path";var F=i=>{let e=M.resolve(i.path);return y.existsSync(e)||y.mkdirSync(e,{recursive:!0}),(t,o,r)=>{if(o.locals||(o.locals={}),t.method==="POST"&&t.headers["content-type"]&&t.headers["content-type"].startsWith("multipart/form-data")){let s=t.headers["content-type"]?.split("; ")[1]?.replace("boundary=","");if(!s)return o.statusCode=400,o.end("Boundary ausente no content-type");let p=[],d=0,k=i.maxFileSize||50*1024*1024;t.on("data",a=>{if(d+=a.length,d>k)return o.statusCode=413,o.end("Arquivo muito grande");p.push(a)}),t.on("end",()=>{try{let a=Buffer.concat(p),u=Buffer.from(`--${s}`),m=0,h=[];for(;(m=a.indexOf(u,m))!==-1;){m+=u.length;let g=a.indexOf(u,m),v=a.slice(m,g!==-1?g:a.length),w=v.indexOf(`\r
\r
`);if(w===-1)break;let N=v.slice(0,w).toString("utf8"),U=v.slice(w+4),S=N.match(/filename="([^"]+)"/);if(S){let b=S[1],$=i.format||M.extname(b),E=b;E+=$;let P=M.join(e,E);y.writeFileSync(P,U),h.push(P)}if(g===-1)break}t.files=h,o.locals.uploadedFilePaths=h,r()}catch(a){console.error("Erro no upload:",a),o.statusCode=500,o.end("Erro no upload")}}),t.on("error",a=>{console.error("Erro no upload:",a),o.statusCode=500,o.end("Erro no upload")})}else r()}},O=F;var W={json:"application/json",html:"text/html",text:"text/plain",binary:"application/octet-stream",css:"text/css",js:"application/javascript",xml:"application/xml",svg:"image/svg+xml",pdf:"application/pdf",ico:"image/x-icon",jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",mp3:"audio/mpeg",wav:"audio/wav",mp4:"video/mp4",webm:"video/webm",zip:"application/zip","7z":"application/x-7z-compressed",ttf:"font/ttf",otf:"font/otf",woff:"font/woff",woff2:"font/woff2",csv:"text/csv",rtf:"application/rtf",tar:"application/x-tar",rar:"application/vnd.rar",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",epub:"application/epub+zip",jsonld:"application/ld+json",md:"text/markdown",xhtml:"application/xhtml+xml",bz:"application/x-bzip",bz2:"application/x-bzip2",sh:"application/x-sh",csh:"application/x-csh",jar:"application/java-archive",xul:"application/vnd.mozilla.xul+xml",azw:"application/vnd.amazon.ebook",webma:"audio/webm",ogg:"audio/ogg",videoOgg:"video/ogg",odt:"application/vnd.oasis.opendocument.text",ods:"application/vnd.oasis.opendocument.spreadsheet",odp:"application/vnd.oasis.opendocument.presentation",tiff:"image/tiff",bmp:"image/bmp",atom:"application/atom+xml",avi:"video/x-msvideo",ics:"text/calendar",midi:"audio/midi",mpeg:"video/mpeg",swf:"application/x-shockwave-flash",torrent:"application/x-bittorrent",yaml:"text/yaml",heic:"image/heic",heif:"image/heif",apk:"application/vnd.android.package-archive",avif:"image/avif",psd:"image/vnd.adobe.photoshop",mpkg:"application/vnd.apple.installer+xml",webmanifest:"application/manifest+json"};function l(i,e){let t=W[e]||"text/plain";i.setHeader("Content-Type",t)}import T from"fs";import L from"path";function z(i){let e=i;return e.send=function(t,o){if(e.headersSent)return e;let r;return typeof t=="string"&&T.existsSync(t)?(r=L.extname(t).toLowerCase().slice(1),l(e,r),T.createReadStream(t).pipe(e),e):(typeof t=="string"?(t.trim().startsWith("<")&&t.trim().endsWith(">")?r="html":r="text",l(e,r),o?e.end(t,o):e.end(t)):typeof t=="object"&&!Buffer.isBuffer(t)?(r="json",l(e,r),e.end(JSON.stringify(t))):Buffer.isBuffer(t)?(r="binary",l(e,r),o?e.end(t,o):e.end(t)):(r="text",l(e,r),o?e.end(String(t),o):e.end(String(t))),e)},e.locals={},e}var C=class{router;prefix;constructor(e=""){this.router=new R,this.prefix=e}get(e,...t){let o=this.prefix+e;this.router.addMiddleware("GET",o,t)}post(e,...t){let o=this.prefix+e;this.router.addMiddleware("POST",o,t)}getRouter(){return this.router}},H=class{middlewares;router;requestHandler;server;constructor(){this.middlewares=[],this.router=new R,this.requestHandler=new j(this.middlewares,this.router),this.server=J.createServer((e,t)=>{let o=e,r=z(t);this.requestHandler.handleRequest(o,r)})}use(e){this.middlewares.push(e)}json(){return B}upload(e){return O(e)}root(e,t){this.router.addRouterWithPrefix(e,t.getRouter())}get(e,...t){this.router.get(e,...t)}post(e,...t){this.router.post(e,...t)}put(e,...t){this.router.put(e,...t)}patch(e,...t){this.router.patch(e,...t)}delete(e,...t){this.router.delete(e,...t)}listen(e,t){this.server.listen(e,t)}};export{C as RootRouter,H as Server};
